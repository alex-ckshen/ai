
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemini Gloss Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Babel Standalone for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            colors: {
              glass: {
                light: 'rgba(255, 255, 255, 0.7)',
                dark: 'rgba(20, 20, 20, 0.7)',
                border: 'rgba(255, 255, 255, 0.2)',
                borderDark: 'rgba(255, 255, 255, 0.1)',
                surface: 'rgba(255, 255, 255, 0.4)',
                surfaceDark: 'rgba(30, 30, 30, 0.4)',
              }
            },
            animation: {
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'glow': 'glow 2s ease-in-out infinite alternate',
              'shimmer': 'shimmer 2s linear infinite',
              'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
              'scale-in': 'scaleIn 0.2s ease-out forwards',
            },
            keyframes: {
              glow: {
                '0%': { boxShadow: '0 0 10px rgba(59, 130, 246, 0.5)' },
                '100%': { boxShadow: '0 0 25px rgba(59, 130, 246, 0.8), 0 0 10px rgba(59, 130, 246, 0.5)' }
              },
              shimmer: {
                '0%': { transform: 'translateX(-100%)' },
                '100%': { transform: 'translateX(100%)' }
              },
              fadeInUp: {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' }
              },
              scaleIn: {
                 '0%': { opacity: '0', transform: 'scale(0.95)' },
                 '100%': { opacity: '1', transform: 'scale(1)' }
              }
            }
          },
        },
      }
    </script>
    <style>
      body {
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent; 
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(156, 163, 175, 0.5); 
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(156, 163, 175, 0.8); 
      }
      
      .glass-panel {
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }
      
      .markdown-body p { margin-bottom: 0.75em; }
      .markdown-body pre { 
        background-color: rgba(0,0,0,0.1); 
        border-radius: 0.5rem; 
        padding: 1rem; 
        overflow-x: auto;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.875rem;
      }
      .dark .markdown-body pre { background-color: rgba(0,0,0,0.3); }
      .markdown-body code {
        font-family: 'JetBrains Mono', monospace;
        background-color: rgba(0,0,0,0.05);
        padding: 0.2em 0.4em;
        border-radius: 0.25rem;
        font-size: 0.875em;
      }
      .dark .markdown-body code { background-color: rgba(255,255,255,0.1); }
      
      /* Markdown List Styles */
      .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.75em; }
      .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.75em; }
      .markdown-body li { margin-bottom: 0.25em; }

      /* Auto-scroll anchor */
      #anchor { overflow-anchor: auto; height: 1px; }

      /* Visual Loading Effect */
      .generating-glow {
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.2), inset 0 0 10px rgba(59, 130, 246, 0.05);
        border-color: rgba(59, 130, 246, 0.3);
      }
      
      .blur-overlay {
         background: linear-gradient(120deg, rgba(59, 130, 246, 0.05) 0%, rgba(147, 51, 234, 0.05) 100%);
         backdrop-filter: blur(2px);
      }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://aistudiocdn.com/react@^19.2.0",
        "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
        "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
        "react-markdown": "https://aistudiocdn.com/react-markdown@^10.1.0"
      }
    }
    </script>
  </head>
  <body class="bg-gray-100 text-gray-900 dark:bg-[#09090b] dark:text-gray-100 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
      import React, { useState, useEffect, useRef, useMemo } from 'react';
      import ReactDOM from 'react-dom/client';
      import { 
        Send, Bot, User, Loader2, Key, Moon, Sun, 
        Trash2, Terminal, Sparkles, AlertCircle, ChevronRight, Settings2,
        LayoutGrid, MessageSquare, Timer, Eye, EyeOff, Crown, Zap, Globe, Brain, Sliders,
        Copy, Check, WrapText, ChevronDown, ChevronUp, ShieldCheck, X, Swords,
        Info, Edit2, CheckSquare, Plus, RotateCcw
      } from 'lucide-react';
      import { GoogleGenAI } from "@google/genai";
      import ReactMarkdown from 'react-markdown';

      // --- Constants ---
      
      const DEFAULT_SYSTEM_PROMPT = "You are a helpful, precise, and creative AI assistant.";

      const MODEL_DATA = {
        "Gemini 2.0": [
          { id: "ui-gemini-2.0-flash", model: "gemini-2.0-flash", label: "Flash" },
          { id: "ui-gemini-2.0-flash-lite", model: "gemini-2.0-flash-lite-preview-02-05", label: "Flash Lite" },
          { id: "ui-gemini-2.0-flash-live", model: "gemini-2.0-flash-exp", label: "Flash Live" }, 
        ],
        "Gemini 2.5": [
          { id: "ui-gemini-2.5-flash", model: "gemini-2.5-flash", label: "Flash" }, 
          { id: "ui-gemini-2.5-flash-lite", model: "gemini-flash-lite-latest", label: "Flash Lite" },
          { id: "ui-gemini-2.5-pro", model: "gemini-3-pro-preview", label: "Pro" },
          { id: "ui-gemini-2.5-flash-live", model: "gemini-2.5-flash", label: "Flash Live" }, 
          { id: "ui-gemini-2.5-native-audio", model: "gemini-2.5-flash", label: "Native Audio" },
        ]
      };

      const COMPARE_MODELS = [
        { id: "cmp-2.0-flash", model: "gemini-2.0-flash", name: "2.0 Flash" },
        { id: "cmp-2.0-lite", model: "gemini-2.0-flash-lite-preview-02-05", name: "2.0 Lite" },
        { id: "cmp-2.0-live", model: "gemini-2.0-flash-exp", name: "2.0 Live" },
        { id: "cmp-2.5-flash", model: "gemini-2.5-flash", name: "2.5 Flash" },
        { id: "cmp-2.5-lite", model: "gemini-flash-lite-latest", name: "2.5 Lite" },
        { id: "cmp-2.5-live", model: "gemini-2.5-flash", name: "2.5 Live" }
      ];

      const DEFAULT_KEYS = [
        { id: 'k1', name: 'API Key 1', key: '' },
      ];

      // --- Components ---

      const ActionButton = ({ onClick, icon: Icon, title, active = false, className = "" }) => (
        <button 
          onClick={onClick}
          className={`p-1.5 rounded-lg transition-all shadow-sm border border-transparent flex items-center justify-center
            ${active 
              ? 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 border-green-200 dark:border-green-800' 
              : 'bg-white/80 dark:bg-black/40 text-gray-400 dark:text-gray-500 hover:bg-gray-100 dark:hover:bg-white/10 hover:text-blue-600 dark:hover:text-blue-300 border-gray-100 dark:border-white/5'
            } ${className}`}
          title={title}
        >
          <Icon size={14} />
        </button>
      );

      const CollapsibleMessage = ({ role, text, groundingMetadata, metrics, isLoading, onCheck, defaultExpanded = false }) => {
        const [isExpanded, setIsExpanded] = useState(defaultExpanded);
        const [showCopied, setShowCopied] = useState(false);
        
        const handleCopy = (e) => {
          e?.stopPropagation();
          navigator.clipboard.writeText(text);
          setShowCopied(true);
          setTimeout(() => setShowCopied(false), 2000);
        };

        const handleDoubleClick = (e) => {
          e.stopPropagation();
          handleCopy();
        };

        const handleClick = (e) => {
          if (window.getSelection().toString().length > 0) return;
          setIsExpanded(!isExpanded);
        };

        // Collapsed View
        if (!isExpanded) {
           return (
              <div className={`flex items-center gap-3 p-1 w-full max-w-4xl mx-auto animate-fade-in-up ${role === 'user' ? 'justify-end' : 'justify-start'}`}>
                 <div 
                    onClick={() => setIsExpanded(true)}
                    className={`
                      relative group flex items-center gap-3 px-4 py-3 rounded-xl border shadow-sm cursor-pointer select-none transition-all w-full md:w-auto md:min-w-[400px] overflow-hidden
                      ${isLoading 
                         ? 'bg-blue-50/50 dark:bg-blue-900/10 border-blue-200 dark:border-blue-800/30' 
                         : 'bg-white dark:bg-[#18181b] border-gray-200 dark:border-gray-800 hover:border-gray-300 dark:hover:border-gray-700'
                      }
                    `}
                 >
                    {/* Animated Loading Gradient Overlay */}
                    {isLoading && (
                       <div className="absolute inset-0 z-0 bg-gradient-to-r from-transparent via-blue-400/10 to-transparent -translate-x-full animate-shimmer" />
                    )}

                    <div className="relative z-10 flex items-center justify-center w-6 h-6 rounded shrink-0 bg-gray-100 dark:bg-white/5 text-gray-500">
                       {role === 'user' ? <User size={14} /> : <Bot size={14} />}
                    </div>

                    <div className="relative z-10 flex-1 min-w-0 flex flex-col gap-0.5">
                       <div className="flex items-center gap-2">
                         <span className="text-xs font-semibold text-gray-700 dark:text-gray-300">
                            {role === 'user' ? 'You' : 'Gemini'}
                         </span>
                         {isLoading && (
                           <span className="flex h-1.5 w-1.5 rounded-full bg-blue-500 animate-pulse" />
                         )}
                       </div>
                       <span className={`text-xs truncate ${isLoading ? 'text-blue-600 dark:text-blue-400 italic' : 'text-gray-500'}`}>
                          {isLoading ? 'Thinking & generating...' : (text.substring(0, 60) + (text.length > 60 ? '...' : ''))}
                       </span>
                    </div>

                    <div className="relative z-10 flex items-center gap-1.5 pl-4 border-l border-gray-100 dark:border-gray-800" onClick={e => e.stopPropagation()}>
                       {role === 'model' && onCheck && !isLoading && (
                          <ActionButton onClick={() => onCheck(text)} icon={ShieldCheck} title="Verify Fact Check" />
                       )}
                       <ActionButton onClick={handleCopy} icon={Copy} title="Copy" />
                       <div className="ml-1 text-gray-400 group-hover:text-blue-500 transition-colors">
                          <ChevronDown size={16} />
                       </div>
                    </div>
                 </div>
              </div>
           )
        }
      
        // Expanded View
        return (
           <div className={`group flex gap-3 w-full max-w-4xl mx-auto animate-fade-in-up ${role === 'user' ? 'justify-end' : 'justify-start'}`}>
              {role === 'model' && (
                <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shrink-0 shadow-lg shadow-blue-500/20 mt-1">
                  <Bot size={16} className="text-white" />
                </div>
              )}
              
              <div className={`flex items-start gap-2 max-w-[85%] ${role === 'user' ? 'flex-row-reverse' : 'flex-row'}`}>
                
                <div 
                  onClick={handleClick}
                  onDoubleClick={handleDoubleClick}
                  className={`
                    relative rounded-2xl px-6 py-4 shadow-sm text-sm leading-relaxed cursor-pointer select-text overflow-hidden
                    transition-all duration-300
                    ${role === 'user' 
                      ? 'bg-blue-600 text-white rounded-tr-sm' 
                      : 'bg-white dark:bg-[#18181b] border border-gray-100 dark:border-gray-800 text-gray-800 dark:text-gray-200 rounded-tl-sm'
                    }
                  `}
                >
                  {showCopied && (
                    <div className="absolute inset-0 flex items-center justify-center bg-black/10 backdrop-blur-[1px] rounded-2xl z-20 pointer-events-none animate-in fade-in zoom-in duration-200">
                      <div className="px-3 py-1.5 bg-black/80 text-white text-xs rounded-full font-medium flex items-center gap-1.5 shadow-xl">
                        <Check size={12} className="text-green-400" />
                        Copied
                      </div>
                    </div>
                  )}

                  <div className="relative z-10">
                    {role === 'model' ? (
                      <div className="markdown-body whitespace-pre-wrap break-words">
                        <ReactMarkdown>{text}</ReactMarkdown>
                      </div>
                    ) : (
                      <div className="whitespace-pre-wrap break-words">{text}</div>
                    )}

                    {groundingMetadata && groundingMetadata.groundingChunks && groundingMetadata.groundingChunks.length > 0 && (
                      <div className="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700/50 clear-both" onClick={e => e.stopPropagation()}>
                        <div className="text-[10px] font-semibold text-gray-500 uppercase tracking-wider mb-2 flex items-center gap-1">
                          <Globe size={10} /> Sources
                        </div>
                        <div className="flex flex-wrap gap-2">
                          {groundingMetadata.groundingChunks.map((chunk, i) => (
                             chunk.web && (
                               <a 
                                 key={i} 
                                 href={chunk.web.uri} 
                                 target="_blank" 
                                 rel="noopener noreferrer"
                                 className="flex items-center gap-1.5 px-2 py-1 bg-gray-100 dark:bg-white/5 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-md text-xs text-blue-600 dark:text-blue-400 transition-colors border border-transparent hover:border-blue-100 dark:hover:border-blue-900/30"
                               >
                                 <span className="truncate max-w-[150px]">{chunk.web.title || "Source"}</span>
                                 <ChevronRight size={10} className="opacity-50" />
                               </a>
                             )
                          ))}
                        </div>
                      </div>
                    )}
                  
                    {metrics && (
                      <div className="flex items-center gap-1 text-[10px] text-gray-400 mt-2 justify-end">
                         <Timer size={10} />
                         {metrics.duration}ms
                      </div>
                    )}
                  </div>
                </div>

                <div className="flex flex-col gap-1 mt-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                   <ActionButton onClick={(e) => { e.stopPropagation(); setIsExpanded(false); }} icon={ChevronUp} title="Collapse" />
                   <ActionButton onClick={handleCopy} icon={Copy} title="Copy" />
                   {role === 'model' && onCheck && (
                      <ActionButton onClick={(e) => { e.stopPropagation(); onCheck(text); }} icon={ShieldCheck} title="Verify" />
                   )}
                </div>
              </div>

              {role === 'user' && (
                <div className="w-8 h-8 rounded-lg bg-gray-200 dark:bg-gray-800 flex items-center justify-center shrink-0 mt-1">
                  <User size={16} className="text-gray-500 dark:text-gray-400" />
                </div>
              )}
           </div>
        )
      }

      // Check Panel Component
      const CheckPanel = ({ checks, onClose }) => {
        return (
          <aside className="w-96 shrink-0 bg-white dark:bg-[#0c0c0e] border-r border-gray-200 dark:border-white/5 flex flex-col z-30 relative shadow-2xl h-full transition-all animate-in slide-in-from-left duration-300">
            <div className="p-5 border-b border-gray-200 dark:border-white/5 flex items-center justify-between bg-gray-50/50 dark:bg-[#121214]">
               <div>
                  <h2 className="text-sm font-bold flex items-center gap-2 text-gray-800 dark:text-gray-100">
                     <ShieldCheck size={18} className="text-green-600" />
                     Fact Verification
                  </h2>
                  <p className="text-[10px] text-gray-500 mt-1">Powered by internal consistency check</p>
               </div>
               <button onClick={onClose} className="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-white/10 text-gray-500 transition-colors">
                 <X size={18} />
               </button>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-100/50 dark:bg-black/20">
               {checks.length === 0 && (
                  <div className="flex flex-col items-center justify-center h-64 text-center text-gray-400 p-4">
                     <ShieldCheck size={48} className="mb-3 opacity-20" />
                     <p className="text-sm">No facts checked yet.</p>
                     <p className="text-xs mt-1 opacity-70">Click the shield icon on any model message to verify its claims.</p>
                  </div>
               )}
               {checks.map((check) => (
                  <div key={check.id} className="group flex flex-col gap-0 rounded-xl bg-white dark:bg-[#18181b] border border-gray-200 dark:border-gray-800 shadow-sm overflow-hidden animate-fade-in-up">
                     <div className="p-3 bg-gray-50 dark:bg-white/5 border-b border-gray-100 dark:border-gray-800">
                        <div className="flex items-center gap-2 mb-1">
                           <Info size={12} className="text-blue-500" />
                           <span className="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Statement</span>
                        </div>
                        <div className="text-xs text-gray-700 dark:text-gray-300 line-clamp-2 italic">
                           "{check.originalText}"
                        </div>
                     </div>
                     <div className="p-4">
                        {check.loading ? (
                           <div className="flex items-center gap-2 text-xs text-gray-500">
                              <Loader2 size={12} className="animate-spin" />
                              Analyzing statement validity...
                           </div>
                        ) : (
                           <div className="markdown-body text-xs text-gray-600 dark:text-gray-300">
                              <ReactMarkdown>{check.result}</ReactMarkdown>
                           </div>
                        )}
                     </div>
                  </div>
               ))}
            </div>
          </aside>
        )
      }

      // 1. API Key Modal (UPDATED)
      const ApiKeyModal = ({ isOpen, onSubmit, apiKeys, setApiKeys, activeKeyId, setActiveKeyId }) => {
        const [visibleKeys, setVisibleKeys] = useState({});

        const toggleVisibility = (id) => {
          setVisibleKeys(prev => ({ ...prev, [id]: !prev[id] }));
        };

        const handleKeyChange = (id, value) => {
          const newKeys = apiKeys.map(k => k.id === id ? { ...k, key: value } : k);
          setApiKeys(newKeys);
        };

        const handleNameChange = (id, value) => {
          const newKeys = apiKeys.map(k => k.id === id ? { ...k, name: value } : k);
          setApiKeys(newKeys);
        };

        const addNewKey = () => {
           const newId = `k${Date.now()}`;
           setApiKeys([...apiKeys, { id: newId, name: `API Key ${apiKeys.length + 1}`, key: '' }]);
        };

        const removeKey = (id) => {
           if (apiKeys.length <= 1) return;
           const newKeys = apiKeys.filter(k => k.id !== id);
           setApiKeys(newKeys);
           if (activeKeyId === id) {
              setActiveKeyId(newKeys[0].id);
           }
        };

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity animate-in fade-in duration-300">
            <div className="bg-white dark:bg-[#18181b] p-6 rounded-2xl shadow-2xl max-w-2xl w-full border border-gray-200 dark:border-gray-800 animate-scale-in">
              <div className="flex flex-col gap-6">
                <div className="flex items-center justify-between border-b border-gray-100 dark:border-gray-800 pb-4">
                   <div className="flex items-center gap-3">
                     <div className="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-full text-blue-600 dark:text-blue-400">
                       <Key size={24} />
                     </div>
                     <div>
                       <h2 className="text-xl font-bold text-gray-900 dark:text-white">Manage API Keys</h2>
                       <p className="text-xs text-gray-500 dark:text-gray-400">
                         Configure keys. Multiple keys allow for rapid rotation.
                       </p>
                     </div>
                   </div>
                </div>
                
                {/* Vertical List */}
                <div className="space-y-3 max-h-[50vh] overflow-y-auto pr-2">
                   {apiKeys.map((k) => {
                      const isActive = activeKeyId === k.id;
                      const isVisible = visibleKeys[k.id];
                      
                      return (
                         <div 
                            key={k.id} 
                            className={`group flex items-center gap-3 p-4 rounded-xl border transition-all relative overflow-hidden ${
                               isActive 
                               ? 'bg-blue-50/50 dark:bg-blue-900/10 border-blue-200 dark:border-blue-800 ring-1 ring-blue-500/20' 
                               : 'bg-gray-50 dark:bg-[#27272a]/50 border-transparent hover:border-gray-300 dark:hover:border-gray-600'
                            }`}
                         >
                            {/* Radio Selection */}
                            <button 
                               onClick={() => setActiveKeyId(k.id)}
                               className={`w-5 h-5 rounded-full border flex items-center justify-center shrink-0 transition-all ${
                                isActive 
                                ? 'border-blue-600 bg-blue-600' 
                                : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-black/20 hover:border-gray-400'
                            }`}>
                                {isActive && <div className="w-2 h-2 bg-white rounded-full" />}
                            </button>

                            {/* Label Input (Left) */}
                            <div className="w-32 shrink-0">
                               <input 
                                 type="text" 
                                 value={k.name}
                                 onChange={(e) => handleNameChange(k.id, e.target.value)}
                                 className="w-full bg-transparent text-sm font-semibold text-gray-700 dark:text-gray-200 focus:outline-none border-b border-transparent focus:border-blue-500 focus:text-blue-600 dark:focus:text-blue-400 transition-all px-1"
                               />
                            </div>
                            
                            {/* Key Input (Right) with Toggle */}
                            <div className="flex-1 flex items-center bg-white dark:bg-black/20 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 focus-within:ring-1 focus-within:ring-blue-500 transition-all">
                               <input
                                  type={isVisible ? "text" : "password"}
                                  value={k.key}
                                  onChange={(e) => handleKeyChange(k.id, e.target.value)}
                                  placeholder={k.id === 'k1' ? "Required API Key..." : "Additional API Key..."}
                                  className={`flex-1 bg-transparent border-none focus:ring-0 text-xs font-mono placeholder-gray-400 dark:placeholder-gray-600 px-0 outline-none ${
                                     isActive ? 'text-gray-900 dark:text-gray-100' : 'text-gray-500 dark:text-gray-500'
                                  }`}
                                />
                                <button 
                                   onClick={() => toggleVisibility(k.id)}
                                   className="ml-2 text-gray-400 hover:text-blue-500 transition-colors p-1"
                                >
                                   {isVisible ? <EyeOff size={14} /> : <Eye size={14} />}
                                </button>
                            </div>

                            {/* Delete Button */}
                            {apiKeys.length > 1 && (
                               <button 
                                  onClick={() => removeKey(k.id)}
                                  className="text-gray-300 hover:text-red-500 transition-colors p-2"
                                  title="Remove Key"
                               >
                                  <Trash2 size={16} />
                               </button>
                            )}
                         </div>
                      );
                   })}
                   
                   <button 
                      onClick={addNewKey}
                      className="w-full py-3 border border-dashed border-gray-300 dark:border-gray-700 rounded-xl text-gray-500 hover:text-blue-500 hover:border-blue-300 dark:hover:border-blue-800 transition-all flex items-center justify-center gap-2 text-sm"
                   >
                      <Plus size={16} />
                      Add Another API Key
                   </button>
                </div>

                <button
                  onClick={() => onSubmit()}
                  disabled={!apiKeys.find(k => k.id === activeKeyId)?.key}
                  className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-blue-500/20"
                >
                  Done
                </button>
              </div>
            </div>
          </div>
        );
      };

      // 2. Model Selector (Chat Mode)
      const ModelSelector = ({ selectedModel, setSelectedModel, selectedFamily, setSelectedFamily }) => {
        return (
          <div className="flex flex-col gap-4 animate-fade-in-up">
            <label className="text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 flex items-center gap-2">
              <Settings2 size={12} />
              Model Configuration
            </label>
            
            <div className="p-3 bg-white/50 dark:bg-black/20 rounded-xl border border-gray-200/50 dark:border-white/5 shadow-sm space-y-4">
              
              {/* Family Group: Gemini 2.0 */}
              <div className="space-y-2">
                <div className="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider pl-1">
                  Gemini 2.0
                </div>
                <div className="flex flex-wrap gap-2">
                  {MODEL_DATA["Gemini 2.0"].map((model) => (
                    <button
                      key={model.id}
                      onClick={() => {
                        setSelectedFamily("Gemini 2.0");
                        setSelectedModel(model.id);
                      }}
                      className={`px-2.5 py-1.5 text-xs font-medium rounded-lg border transition-all truncate flex-1 min-w-[70px] ${
                        selectedModel === model.id
                          ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 text-blue-700 dark:text-blue-300 shadow-sm'
                          : 'bg-white dark:bg-white/5 border-transparent hover:border-gray-300 dark:hover:border-gray-600 text-gray-700 dark:text-gray-300'
                      }`}
                    >
                      {model.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Family Group: Gemini 2.5 */}
              <div className="space-y-2">
                <div className="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider pl-1">
                  Gemini 2.5
                </div>
                <div className="grid grid-cols-2 gap-2">
                  {MODEL_DATA["Gemini 2.5"].map((model) => (
                    <button
                      key={model.id}
                      onClick={() => {
                        setSelectedFamily("Gemini 2.5");
                        setSelectedModel(model.id);
                      }}
                      className={`px-2.5 py-1.5 text-xs font-medium rounded-lg border transition-all truncate text-left ${
                        selectedModel === model.id
                          ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 text-blue-700 dark:text-blue-300 shadow-sm'
                          : 'bg-white dark:bg-white/5 border-transparent hover:border-gray-300 dark:hover:border-gray-600 text-gray-700 dark:text-gray-300'
                      }`}
                    >
                      {model.label}
                    </button>
                  ))}
                </div>
              </div>

            </div>
          </div>
        );
      };

      // 3. Advanced Tools Component
      const AdvancedTools = ({ 
        enableSearch, 
        setEnableSearch, 
        thinkingMode, 
        setThinkingMode, 
        thinkingBudget, 
        setThinkingBudget,
        selectedFamily
      }) => {
        const isThinkingSupported = selectedFamily === "Gemini 2.5";

        return (
          <div className="flex flex-col gap-4 animate-fade-in-up">
             <label className="text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 flex items-center gap-2">
                <Zap size={12} />
                Tools & Settings
             </label>
             <div className="p-3 bg-white/50 dark:bg-black/20 rounded-xl border border-gray-200/50 dark:border-white/5 shadow-sm space-y-4">
                
                {/* Google Search Toggle */}
                <div className="flex items-center justify-between">
                   <div className="flex items-center gap-2">
                      <div className={`p-1.5 rounded-md ${enableSearch ? 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400' : 'bg-gray-100 text-gray-500 dark:bg-white/10 dark:text-gray-400'}`}>
                        <Globe size={14} />
                      </div>
                      <div className="flex flex-col">
                        <span className="text-xs font-medium text-gray-700 dark:text-gray-200">Google Search</span>
                        <span className="text-[10px] text-gray-500">Grounding</span>
                      </div>
                   </div>
                   <button 
                      onClick={() => setEnableSearch(!enableSearch)}
                      className={`w-8 h-4 rounded-full transition-colors relative ${enableSearch ? 'bg-blue-600' : 'bg-gray-300 dark:bg-gray-600'}`}
                   >
                      <div className={`absolute top-0.5 w-3 h-3 rounded-full bg-white transition-transform shadow-sm ${enableSearch ? 'left-[18px]' : 'left-0.5'}`} />
                   </button>
                </div>

                {/* Thinking Config */}
                {isThinkingSupported && (
                  <div className="space-y-3 pt-3 border-t border-gray-100 dark:border-white/5">
                    <div className="flex items-center justify-between">
                       <div className="flex items-center gap-2">
                          <div className={`p-1.5 rounded-md ${thinkingMode !== 'off' ? 'bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400' : 'bg-gray-100 text-gray-500 dark:bg-white/10 dark:text-gray-400'}`}>
                            <Brain size={14} />
                          </div>
                          <div className="flex flex-col">
                            <span className="text-xs font-medium text-gray-700 dark:text-gray-200">Thinking</span>
                            <span className="text-[10px] text-gray-500">Reasoning Budget</span>
                          </div>
                       </div>
                       <select 
                          value={thinkingMode}
                          onChange={(e) => setThinkingMode(e.target.value)}
                          className="bg-transparent text-xs border border-gray-200 dark:border-gray-700 rounded px-1 py-0.5 text-gray-700 dark:text-gray-300 focus:outline-none"
                       >
                          <option value="auto">Auto</option>
                          <option value="custom">Custom</option>
                          <option value="off">Off</option>
                       </select>
                    </div>

                    {thinkingMode === 'custom' && (
                       <div className="space-y-1">
                          <div className="flex justify-between text-[10px] text-gray-500">
                             <span>1024</span>
                             <span className="font-mono text-purple-600 dark:text-purple-400">{thinkingBudget}</span>
                             <span>32k</span>
                          </div>
                          <input 
                             type="range" 
                             min="1024" 
                             max="32768" 
                             step="1024"
                             value={thinkingBudget}
                             onChange={(e) => setThinkingBudget(Number(e.target.value))}
                             className="w-full h-1 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-purple-600"
                          />
                       </div>
                    )}
                  </div>
                )}
             </div>
          </div>
        )
      }

      // 4. Compare Toggles (Compare Mode)
      const CompareToggles = ({ 
        activeModels, 
        toggleModel, 
        enableSearch, 
        setEnableSearch, 
        thinkingConfigs, 
        setThinkingConfigs
      }) => {

        const updateThinking = (id, field, value) => {
           setThinkingConfigs(prev => ({
              ...prev,
              [id]: { ...prev[id] || { mode: 'off', budget: 1024 }, [field]: value }
           }));
        };

        return (
           <div className="flex flex-col gap-4 animate-fade-in-up">
            <label className="text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 flex items-center gap-2">
              <Zap size={12} />
              Compare Tools
            </label>
            <div className="p-3 bg-white/50 dark:bg-black/20 rounded-xl border border-gray-200/50 dark:border-white/5 shadow-sm space-y-3">
               {/* Global Search Toggle */}
               <div className="flex items-center justify-between">
                   <div className="flex items-center gap-2">
                      <div className={`p-1.5 rounded-md ${enableSearch ? 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400' : 'bg-gray-100 text-gray-500 dark:bg-white/10 dark:text-gray-400'}`}>
                        <Globe size={14} />
                      </div>
                      <div className="flex flex-col">
                        <span className="text-xs font-medium text-gray-700 dark:text-gray-200">All: Search</span>
                      </div>
                   </div>
                   <button 
                      onClick={() => setEnableSearch(!enableSearch)}
                      className={`w-8 h-4 rounded-full transition-colors relative ${enableSearch ? 'bg-blue-600' : 'bg-gray-300 dark:bg-gray-600'}`}
                   >
                      <div className={`absolute top-0.5 w-3 h-3 rounded-full bg-white transition-transform shadow-sm ${enableSearch ? 'left-[18px]' : 'left-0.5'}`} />
                   </button>
                </div>
            </div>

            <label className="text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 flex items-center gap-2 mt-2">
              <Eye size={12} />
              Active Models
            </label>
            <div className="space-y-2">
                {COMPARE_MODELS.map(model => {
                  const isActive = activeModels.includes(model.id);
                  const isThinkingSupported = model.id.includes("2.5");
                  const tConfig = thinkingConfigs[model.id] || { mode: 'off', budget: 1024 };

                  return (
                    <div 
                      key={model.id}
                      className={`rounded-lg border transition-all overflow-hidden ${
                        isActive 
                        ? 'bg-white dark:bg-black/20 border-blue-200 dark:border-blue-900/50' 
                        : 'bg-white/50 dark:bg-white/5 border-transparent opacity-70'
                      }`}
                    >
                      {/* Header Row */}
                      <div className="flex items-center justify-between p-2.5">
                         <span className={`text-xs font-medium ${isActive ? 'text-blue-700 dark:text-blue-300' : 'text-gray-500'}`}>
                           {model.name}
                         </span>
                         <button onClick={() => toggleModel(model.id)}>
                            {isActive ? <Eye size={14} className="text-blue-600 dark:text-blue-400" /> : <EyeOff size={14} className="text-gray-400" />}
                         </button>
                      </div>

                      {/* Config Row (Thinking) */}
                      {isActive && isThinkingSupported && (
                        <div className="px-2.5 pb-2.5 pt-1 border-t border-gray-100 dark:border-white/5 bg-gray-50/50 dark:bg-white/[0.02]">
                           <div className="flex items-center justify-between mb-1.5">
                              <div className="flex items-center gap-1.5 text-[10px] text-gray-500">
                                 <Brain size={10} />
                                 <span>Thinking</span>
                              </div>
                              <select 
                                value={tConfig.mode}
                                onChange={(e) => updateThinking(model.id, 'mode', e.target.value)}
                                className="bg-transparent text-[10px] border border-gray-200 dark:border-gray-700 rounded px-1 py-0.5 text-gray-700 dark:text-gray-300 focus:outline-none"
                             >
                                <option value="off">Off</option>
                                <option value="auto">Auto</option>
                                <option value="custom">Set</option>
                             </select>
                           </div>
                           
                           {tConfig.mode === 'custom' && (
                              <div className="flex items-center gap-2">
                                <input 
                                   type="range" 
                                   min="1024" 
                                   max="32768" 
                                   step="1024"
                                   value={tConfig.budget}
                                   onChange={(e) => updateThinking(model.id, 'budget', Number(e.target.value))}
                                   className="flex-1 h-1 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-purple-600"
                                />
                                <span className="text-[9px] font-mono text-gray-500 w-8 text-right">{Math.round(tConfig.budget/1024)}k</span>
                              </div>
                           )}
                        </div>
                      )}
                    </div>
                  )
                })}
            </div>
           </div>
        )
      }

      // 5. Chat Interface Component
      const ChatInterface = ({ 
        messages, 
        input, 
        setInput, 
        isLoading, 
        handleSend, 
        selectedFamily, 
        selectedModel,
        currentModelLabel,
        messagesEndRef,
        chatContainerRef,
        onCheck,
        checks,
        onCloseCheckPanel,
        activeKeyName
      }) => {
        return (
          <div className="flex-1 flex h-full overflow-hidden">
             {/* Left Panel for Checks */}
             {checks.length > 0 && (
                <CheckPanel checks={checks} onClose={onCloseCheckPanel} />
             )}

            <main className="flex-1 flex flex-col min-w-0 relative bg-white/50 dark:bg-[#09090b] glass-panel transition-colors duration-500 h-full">
              {/* Header */}
              <header className="absolute top-0 left-0 right-0 z-10 p-6 flex items-center justify-between pointer-events-none">
                <div className="pointer-events-auto">
                  <h1 className="text-3xl font-bold tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600 dark:from-blue-400 dark:to-purple-400 drop-shadow-sm">
                    {selectedFamily}
                  </h1>
                  <div className="flex items-center gap-2 mt-1">
                    <span className="text-xs font-mono uppercase tracking-widest text-gray-500 dark:text-gray-500">
                      RUNNING
                    </span>
                    <span className="text-xs font-bold px-2 py-0.5 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-800">
                      {currentModelLabel}
                    </span>
                    <span className="text-xs font-mono px-2 py-0.5 text-gray-400 border border-gray-200 dark:border-white/10 rounded-full">
                       {activeKeyName}
                    </span>
                  </div>
                </div>
              </header>

              {/* Messages */}
              <div 
                ref={chatContainerRef}
                className="flex-1 overflow-y-auto px-4 md:px-20 pt-32 pb-4 scroll-smooth"
              >
                {messages.length === 0 ? (
                  <div className="h-full flex flex-col items-center justify-center opacity-40 select-none animate-scale-in">
                    <div className="w-24 h-24 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 opacity-20 blur-xl absolute"></div>
                    <Sparkles size={48} className="text-gray-400 dark:text-gray-600 mb-4 relative z-10" />
                    <p className="text-xl font-medium text-gray-400 dark:text-gray-600">Start a conversation</p>
                  </div>
                ) : (
                  <div className="space-y-6 max-w-4xl mx-auto">
                    {messages.map((msg, idx) => (
                      <CollapsibleMessage
                         key={idx}
                         role={msg.role}
                         text={msg.text}
                         groundingMetadata={msg.groundingMetadata}
                         metrics={msg.metrics}
                         isLoading={false} // Only active streaming is loading
                         onCheck={onCheck}
                         defaultExpanded={false}
                      />
                    ))}
                    {isLoading && (
                       <CollapsibleMessage
                          role="model"
                          text=""
                          isLoading={true}
                          defaultExpanded={false}
                       />
                    )}
                    <div ref={messagesEndRef} className="h-px w-full" />
                  </div>
                )}
              </div>

              {/* Input */}
              <div className="p-6 bg-gradient-to-t from-white via-white/80 to-transparent dark:from-[#09090b] dark:via-[#09090b]/80 dark:to-transparent z-20">
                <div className="max-w-4xl mx-auto relative group">
                  <div className="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl opacity-20 group-focus-within:opacity-50 transition duration-500 blur"></div>
                  <div className="relative flex items-end gap-2 bg-white dark:bg-[#18181b] rounded-xl p-2 border border-gray-200 dark:border-gray-800 shadow-xl">
                    <textarea
                      value={input}
                      onChange={(e) => setInput(e.target.value)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                          e.preventDefault();
                          handleSend();
                        }
                      }}
                      placeholder={`Message ${selectedFamily} ${currentModelLabel}...`}
                      className={`w-full bg-transparent border-none focus:ring-0 resize-none max-h-40 min-h-[50px] py-3 px-4 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 whitespace-pre-wrap`}
                      rows={1}
                      style={{ height: 'auto', minHeight: '52px' }} 
                    />
                    <button
                      onClick={handleSend}
                      disabled={!input.trim() || isLoading}
                      className="mb-1 p-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-50 disabled:bg-gray-400 transition-all shadow-lg shadow-blue-600/20"
                    >
                      {isLoading ? <Loader2 size={18} className="animate-spin" /> : <Send size={18} />}
                    </button>
                  </div>
                </div>
              </div>
            </main>
          </div>
        );
      }

      // 6. Compare Interface Component
      const CompareInterface = ({ 
        compareResults,
        isComparing,
        compareInput,
        setCompareInput,
        handleCompare,
        activeModels,
        activeKeyName
      }) => {

        // Calculate winner based on highest speed (chars/sec)
        const winnerId = useMemo(() => {
          if (isComparing) return null;
          let maxSpeed = -1;
          let wId = null;
          
          Object.entries(compareResults).forEach(([id, result]) => {
            if (!result.loading && !result.error && result.speed > maxSpeed) {
              maxSpeed = result.speed;
              wId = id;
            }
          });
          return wId;
        }, [compareResults, isComparing]);

        const activeModelsList = COMPARE_MODELS.filter(m => activeModels.includes(m.id));

        return (
          <main className="flex-1 flex flex-col min-w-0 relative bg-gray-50 dark:bg-[#0c0c0e] h-full overflow-hidden">
            <header className="px-6 py-4 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-[#09090b] flex items-center gap-2">
              <LayoutGrid size={20} className="text-blue-600 dark:text-blue-400" />
              <h1 className="text-lg font-bold">Compare Models</h1>
              <span className="text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-800 rounded-full text-gray-500 ml-2">
                {activeModels.length} Active
              </span>
              <span className="text-xs font-mono px-2 py-0.5 text-gray-400 border border-gray-200 dark:border-white/10 rounded-full ml-auto">
                 {activeKeyName}
              </span>
            </header>

            {/* Grid Container */}
            <div className="flex-1 w-full overflow-hidden flex flex-col">
              <div className="flex-1 flex w-full h-full divide-x divide-gray-200 dark:divide-gray-800 overflow-x-hidden">
                {activeModelsList.length === 0 ? (
                  <div className="w-full flex flex-col items-center justify-center text-gray-400">
                    <EyeOff size={48} className="mb-4 opacity-20" />
                    <p>No models selected. Use the sidebar to enable models.</p>
                  </div>
                ) : (
                  activeModelsList.map((model) => {
                    const result = compareResults[model.id];
                    const isWinner = winnerId === model.id;

                    return (
                      <div key={model.id} className="flex-1 min-w-0 flex flex-col h-full bg-white/50 dark:bg-[#09090b]/50 animate-fade-in-up">
                        {/* Column Header */}
                        <div className={`p-3 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center sticky top-0 ${isWinner ? 'bg-yellow-50/50 dark:bg-yellow-900/10' : 'bg-gray-50/50 dark:bg-[#121214]'}`}>
                          <div className="flex items-center gap-1.5 overflow-hidden">
                            {isWinner && <Crown size={14} className="text-yellow-500 fill-yellow-500 shrink-0" />}
                            <span className={`font-mono text-xs font-bold truncate ${isWinner ? 'text-yellow-700 dark:text-yellow-500' : 'text-gray-700 dark:text-gray-200'}`}>
                              {model.name}
                            </span>
                          </div>
                          {result?.duration && (
                            <span className={`text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1 shrink-0 ${
                              isWinner 
                                ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 font-bold' 
                                : 'bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400'
                            }`}>
                              <Timer size={8} /> {result.duration}ms
                            </span>
                          )}
                        </div>
                        
                        {/* Content Area */}
                        <div className={`flex-1 overflow-y-auto p-4 text-xs leading-relaxed text-gray-800 dark:text-gray-200 scrollbar-thin whitespace-pre-wrap break-words`}>
                          {!result && !isComparing && (
                            <div className="h-full flex items-center justify-center opacity-10">
                              <Bot size={24} />
                            </div>
                          )}
                          {result?.loading && (
                            <div className="flex items-center gap-2 text-gray-400 animate-pulse">
                              <Loader2 size={14} className="animate-spin" />
                              <span>Generating...</span>
                            </div>
                          )}
                          {result?.error && (
                            <div className="text-red-500 p-2 bg-red-50 dark:bg-red-900/10 rounded break-words">
                              {result.error}
                            </div>
                          )}
                          {result?.text && (
                            <div className={`markdown-body text-xs break-words`}>
                               <ReactMarkdown>{result.text}</ReactMarkdown>
                               {/* Grounding in Compare */}
                               {result.groundingMetadata?.groundingChunks?.length > 0 && (
                                 <div className="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700/50">
                                   <div className="text-[9px] font-semibold text-gray-500 uppercase tracking-wider mb-2 flex items-center gap-1">
                                     <Globe size={10} /> Sources
                                   </div>
                                   <div className="flex flex-col gap-1">
                                     {result.groundingMetadata.groundingChunks.map((chunk, i) => (
                                        chunk.web && (
                                          <a 
                                            key={i} 
                                            href={chunk.web.uri} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            className="flex items-center gap-1.5 px-2 py-1 bg-gray-100 dark:bg-white/5 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-md text-[10px] text-blue-600 dark:text-blue-400 transition-colors"
                                          >
                                            <span className="truncate">{chunk.web.title || "Source"}</span>
                                            <ChevronRight size={10} className="opacity-50 ml-auto" />
                                          </a>
                                        )
                                     ))}
                                   </div>
                                 </div>
                               )}
                            </div>
                          )}
                        </div>
                      </div>
                    )
                  })
                )}
              </div>
            </div>

            {/* Input */}
            <div className="p-4 border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-[#09090b]">
              <div className="max-w-5xl mx-auto flex gap-2">
                <input
                   type="text"
                   value={compareInput}
                   onChange={(e) => setCompareInput(e.target.value)}
                   onKeyDown={(e) => e.key === 'Enter' && handleCompare()}
                   disabled={activeModelsList.length === 0}
                   placeholder={activeModelsList.length === 0 ? "Select at least one model..." : "Enter a prompt to compare..."}
                   className={`flex-1 bg-gray-100 dark:bg-[#18181b] border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white text-sm disabled:opacity-50 disabled:cursor-not-allowed whitespace-pre-wrap`}
                />
                <button
                  onClick={handleCompare}
                  disabled={!compareInput.trim() || isComparing || activeModelsList.length === 0}
                  className="px-6 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 shadow-lg shadow-blue-600/20"
                >
                  {isComparing ? <Loader2 size={16} className="animate-spin" /> : <Send size={16} />}
                  Run
                </button>
              </div>
            </div>
          </main>
        );
      }

      // 7. Rapid Fire Interface Component (UPDATED)
      const RapidFireInterface = ({
        activeModels,
        input,
        setInput,
        handleStart,
        handleStop,
        isRunning,
        stats,
        activeKeyName,
        enableKeyRotation,
        setEnableKeyRotation
      }) => {
        const activeModelsList = COMPARE_MODELS.filter(m => activeModels.includes(m.id));

        return (
           <main className="flex-1 flex flex-col min-w-0 relative bg-gray-50 dark:bg-[#0c0c0e] h-full overflow-hidden">
             <header className="px-6 py-4 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-[#09090b] flex items-center gap-2 justify-between">
               <div className="flex items-center gap-2">
                  <Swords size={20} className="text-red-600 dark:text-red-400" />
                  <h1 className="text-lg font-bold">Rapid Fire Test</h1>
                  <span className="text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-800 rounded-full text-gray-500 ml-2">
                    Rate Limit Stress Test
                  </span>
               </div>
               
               <div className="flex items-center gap-4">
                 {/* Key Rotation Toggle */}
                 <div className="flex items-center gap-2 border-r border-gray-200 dark:border-gray-800 pr-4">
                    <div className="flex flex-col items-end">
                       <span className="text-[10px] font-bold text-gray-500 uppercase">Auto-Switch Keys</span>
                       <span className="text-[9px] text-gray-400">On rate limit error</span>
                    </div>
                    <button 
                       onClick={() => setEnableKeyRotation(!enableKeyRotation)}
                       className={`w-10 h-6 rounded-full transition-colors relative ${enableKeyRotation ? 'bg-blue-600' : 'bg-gray-300 dark:bg-gray-700'}`}
                       title="Rotate API keys automatically when rate limit is reached"
                    >
                       <div className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-transform shadow-sm flex items-center justify-center ${enableKeyRotation ? 'left-[22px]' : 'left-1'}`}>
                          <RotateCcw size={10} className={`${enableKeyRotation ? 'text-blue-600' : 'text-gray-400'}`} />
                       </div>
                    </button>
                 </div>

                 <span className="text-xs font-mono px-2 py-0.5 text-gray-400 border border-gray-200 dark:border-white/10 rounded-full">
                   {activeKeyName} (Primary)
                 </span>
               </div>
             </header>

             <div className="flex-1 w-full overflow-hidden flex flex-col">
               <div className="flex-1 flex w-full h-full divide-x divide-gray-200 dark:divide-gray-800 overflow-x-hidden">
                 {activeModelsList.length === 0 ? (
                    <div className="w-full flex flex-col items-center justify-center text-gray-400">
                      <EyeOff size={48} className="mb-4 opacity-20" />
                      <p>No models selected. Use the sidebar to enable models.</p>
                    </div>
                  ) : (
                    activeModelsList.map(model => {
                      const stat = stats[model.id] || { count: 0, lastDuration: 0, error: null, active: false, history: [], isRetrying: false, currentKeyName: activeKeyName };
                      
                      return (
                        <div key={model.id} className="flex-1 min-w-0 flex flex-col h-full bg-white/50 dark:bg-[#09090b]/50 relative transition-all duration-300 hover:bg-white dark:hover:bg-[#09090b] animate-fade-in-up">
                          {/* Retrying Popup Overlay */}
                          {stat.isRetrying && (
                             <div className="absolute top-12 inset-x-4 z-20 animate-in slide-in-from-top-2 fade-in duration-200">
                                <div className="bg-yellow-100 dark:bg-yellow-900/80 border border-yellow-200 dark:border-yellow-700/50 shadow-lg backdrop-blur-sm rounded-lg p-3 flex items-center justify-center gap-2 text-yellow-700 dark:text-yellow-400 text-xs font-bold">
                                   <Loader2 size={14} className="animate-spin" />
                                   Retrying Request...
                                </div>
                             </div>
                          )}
                          
                          {/* Header */}
                          <div className={`p-3 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center ${stat.error && !stat.isRetrying ? 'bg-red-50 dark:bg-red-900/10' : 'bg-gray-50/50 dark:bg-[#121214]'}`}>
                             <div className="flex flex-col min-w-0">
                                <span className="font-mono text-xs font-bold truncate text-gray-700 dark:text-gray-200">
                                   {model.name}
                                </span>
                                <span className="text-[9px] text-gray-400 truncate">
                                   Key: {stat.currentKeyName || activeKeyName}
                                </span>
                             </div>
                             <div className="flex items-center gap-2">
                               {stat.active && <Loader2 size={12} className="animate-spin text-blue-500" />}
                               <span className="text-xs font-bold text-gray-500">#{stat.count}</span>
                             </div>
                          </div>
                          
                          {/* Body */}
                          <div className="flex-1 p-4 overflow-y-auto scrollbar-thin">
                             <div className="grid grid-cols-2 gap-2 text-center mb-4">
                                <div className="p-2 bg-white dark:bg-white/5 rounded border border-gray-100 dark:border-white/5">
                                   <div className="text-[10px] text-gray-500 uppercase">Requests</div>
                                   <div className="text-xl font-bold">{stat.count}</div>
                                </div>
                                <div className="p-2 bg-white dark:bg-white/5 rounded border border-gray-100 dark:border-white/5">
                                   <div className="text-[10px] text-gray-500 uppercase">Last Latency</div>
                                   <div className="text-xl font-bold font-mono">{stat.lastDuration.toFixed(0)}ms</div>
                                </div>
                             </div>
                             
                             {stat.error && !stat.isRetrying && (
                                <div className={`p-3 rounded-lg text-xs break-words mb-4 flex items-start gap-2 bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300`}>
                                    <AlertCircle size={14} className="shrink-0 mt-0.5"/>
                                    <div>
                                        {stat.error}
                                    </div>
                                </div>
                             )}

                             {/* Stacked History */}
                             <div className="space-y-2">
                               {stat.history?.length > 0 && (
                                  <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">History Stack</div>
                               )}
                               {stat.history?.map((item) => (
                                 <div key={item.id} className="p-2 text-xs bg-white dark:bg-white/5 border border-gray-100 dark:border-white/5 rounded truncate opacity-80 hover:opacity-100 transition-opacity animate-fade-in-up">
                                    <span className="font-bold mr-2 text-gray-400">#{item.id}</span>
                                    {item.text.length > 50 ? item.text.substring(0, 50) + "..." : item.text}
                                    <span className="float-right text-[10px] text-gray-400">{item.duration.toFixed(0)}ms</span>
                                 </div>
                               ))}
                             </div>
                          </div>
                        </div>
                      )
                    })
                  )}
               </div>
             </div>

             <div className="p-4 border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-[#09090b]">
              <div className="max-w-5xl mx-auto flex gap-2">
                <input
                   type="text"
                   value={input}
                   onChange={(e) => setInput(e.target.value)}
                   disabled={isRunning || activeModelsList.length === 0}
                   placeholder={activeModelsList.length === 0 ? "Select at least one model..." : "Enter prompt for stress test..."}
                   className={`flex-1 bg-gray-100 dark:bg-[#18181b] border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white text-sm disabled:opacity-50 disabled:cursor-not-allowed`}
                />
                {!isRunning ? (
                   <button
                     onClick={handleStart}
                     disabled={!input.trim() || activeModelsList.length === 0}
                     className="px-6 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 shadow-lg shadow-red-600/20"
                   >
                     <Swords size={16} />
                     Start Fire
                   </button>
                ) : (
                   <button
                     onClick={handleStop}
                     className="px-6 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium text-sm transition-colors flex items-center gap-2"
                   >
                     <X size={16} />
                     Stop
                   </button>
                )}
              </div>
            </div>
           </main>
        )
      }

      // 8. Main App Component
      const App = () => {
        // --- State ---
        const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'light');
        const [apiKeys, setApiKeys] = useState(() => {
          const saved = localStorage.getItem('gemini_api_keys');
          return saved ? JSON.parse(saved) : DEFAULT_KEYS;
        });
        const [activeKeyId, setActiveKeyId] = useState(() => localStorage.getItem('gemini_active_key_id') || 'k1');
        
        const [isKeyModalOpen, setIsKeyModalOpen] = useState(false);
        const [viewMode, setViewMode] = useState('chat'); // 'chat' | 'compare' | 'rapid'
        const [isSysPromptExpanded, setIsSysPromptExpanded] = useState(false);

        // Computed Active Key
        const activeKeyObj = apiKeys.find(k => k.id === activeKeyId) || apiKeys[0];
        const apiKey = activeKeyObj.key;

        // Chat State
        const [messages, setMessages] = useState([]);
        const [input, setInput] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [systemPrompt, setSystemPrompt] = useState(DEFAULT_SYSTEM_PROMPT);
        
        // Advanced Tools State - UPDATED DEFAULTS
        const [enableSearch, setEnableSearch] = useState(true); // Default ON
        const [thinkingMode, setThinkingMode] = useState('off'); // Default OFF
        const [thinkingBudget, setThinkingBudget] = useState(1024);

        // Check/Verify State
        const [checks, setChecks] = useState([]);
        const [isCheckPanelOpen, setIsCheckPanelOpen] = useState(false);

        // Compare State
        const [compareInput, setCompareInput] = useState('');
        const [isComparing, setIsComparing] = useState(false);
        const [compareResults, setCompareResults] = useState({});
        const [activeCompareModels, setActiveCompareModels] = useState(COMPARE_MODELS.map(m => m.id));
        const [enableCompareSearch, setEnableCompareSearch] = useState(true); // Default ON
        const [compareThinkingConfigs, setCompareThinkingConfigs] = useState({});

        // Rapid Fire State
        const [rapidInput, setRapidInput] = useState('');
        const [isRapidFiring, setIsRapidFiring] = useState(false);
        const [rapidStats, setRapidStats] = useState({});
        const [enableKeyRotation, setEnableKeyRotation] = useState(false);

        const rapidControllerRef = useRef(null);

        // Model Selection State (Chat Mode)
        const [selectedFamily, setSelectedFamily] = useState("Gemini 2.5");
        const [selectedModel, setSelectedModel] = useState("ui-gemini-2.5-flash");

        // Refs
        const messagesEndRef = useRef(null);
        const chatContainerRef = useRef(null);

        // --- Effects ---
        useEffect(() => {
          if (theme === 'dark') document.documentElement.classList.add('dark');
          else document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', theme);
        }, [theme]);

        useEffect(() => {
           localStorage.setItem('gemini_api_keys', JSON.stringify(apiKeys));
           localStorage.setItem('gemini_active_key_id', activeKeyId);
           // Open modal if current key is empty
           if (!apiKey && !isKeyModalOpen) {
              setIsKeyModalOpen(true);
           }
        }, [apiKeys, activeKeyId]);

        useEffect(() => {
          if (viewMode === 'chat') {
             messagesEndRef.current?.scrollIntoView({ behavior: 'smooth', block: 'end' });
          }
        }, [messages, isLoading, viewMode]);

        // --- Handlers ---

        const handleApiKeySubmit = () => {
          setIsKeyModalOpen(false);
        };

        const handleClearChat = () => {
          setMessages([]);
          setInput('');
          setCompareResults({});
          setRapidStats({});
          setChecks([]);
          setIsCheckPanelOpen(false);
        };

        const toggleCompareModel = (modelId) => {
          setActiveCompareModels(prev => 
            prev.includes(modelId) 
              ? prev.filter(id => id !== modelId)
              : [...prev, modelId]
          );
        };

        const handleCheck = async (originalText) => {
           if (!originalText) return;
           setIsCheckPanelOpen(true);
           const checkId = Date.now().toString();
           
           // Add pending check
           setChecks(prev => [{
              id: checkId,
              originalText,
              result: '',
              loading: true
           }, ...prev]);

           try {
              const ai = new GoogleGenAI({ apiKey });
              const response = await ai.models.generateContent({
                model: "gemini-2.5-flash",
                contents: [{ 
                  role: 'user', 
                  parts: [{ text: `Verify the accuracy of the following statement and provide a brief fact-check:\n\n"${originalText}"` }] 
                }]
              });
              
              const text = response.text;
              
              setChecks(prev => prev.map(c => 
                 c.id === checkId ? { ...c, result: text, loading: false } : c
              ));
           } catch (error) {
              setChecks(prev => prev.map(c => 
                 c.id === checkId ? { ...c, result: `Error: ${error.message}`, loading: false } : c
              ));
           }
        };

        // Chat Send Handler
        const handleSend = async () => {
          if (!input.trim() || isLoading) return;
          const currentInput = input.trim();
          setInput('');
          
          const startTime = performance.now();
          const userMsg = { role: 'user', text: currentInput, timestamp: Date.now() };
          setMessages(prev => [...prev, userMsg]);
          setIsLoading(true);

          try {
            const ai = new GoogleGenAI({ apiKey });
            const history = messages.map(m => ({
              role: m.role,
              parts: [{ text: m.text }]
            }));

            const modelConfig = MODEL_DATA[selectedFamily].find(m => m.id === selectedModel);
            const apiModelName = modelConfig ? modelConfig.model : "gemini-2.5-flash";

            const effectiveSystemPrompt = enableSearch 
               ? systemPrompt + "\n\nIMPORTANT: You have access to Google Search. If the user's query asks for current information, facts, or data that you do not have in your internal knowledge base, you MUST use the googleSearch tool. When using the tool, simply output the search query. DO NOT output any conversational text before the search tool call." 
               : systemPrompt;

            const requestConfig = {
              systemInstruction: effectiveSystemPrompt,
              temperature: 0.7,
            };

            if (enableSearch) {
              requestConfig.tools = [{ googleSearch: {} }];
            }

            if (selectedFamily === "Gemini 2.5") {
               if (thinkingMode === 'custom') {
                 requestConfig.thinkingConfig = { thinkingBudget: thinkingBudget };
               } else if (thinkingMode === 'off') {
                 requestConfig.thinkingConfig = { thinkingBudget: 0 };
               }
            }

            const chatSession = ai.chats.create({
              model: apiModelName,
              config: requestConfig,
              history: history,
            });

            setMessages(prev => [...prev, { role: 'model', text: '', timestamp: Date.now() }]);

            const result = await chatSession.sendMessageStream({ message: currentInput });
            
            let fullText = "";
            let finalGroundingMetadata = null;

            for await (const chunk of result) {
              const text = chunk.text;
              if (text) fullText += text;
              
              if (chunk.candidates?.[0]?.groundingMetadata) {
                finalGroundingMetadata = chunk.candidates[0].groundingMetadata;
              }

              setMessages(prev => {
                const newMsgs = [...prev];
                const lastMsg = newMsgs[newMsgs.length - 1];
                if (lastMsg.role === 'model') {
                  lastMsg.text = fullText;
                  if (finalGroundingMetadata) {
                    lastMsg.groundingMetadata = finalGroundingMetadata;
                  }
                }
                return newMsgs;
              });
            }
            
            const endTime = performance.now();
            const duration = (endTime - startTime).toFixed(0);
            
            setMessages(prev => {
               const newMsgs = [...prev];
               const lastMsg = newMsgs[newMsgs.length - 1];
               if (lastMsg.role === 'model') {
                 lastMsg.metrics = { duration };
               }
               return newMsgs;
            });

          } catch (error) {
            console.error("GenAI Error:", error);
            const modelConfig = MODEL_DATA[selectedFamily].find(m => m.id === selectedModel);
            const apiModelName = modelConfig ? modelConfig.model : selectedModel;
            let errorMessage = error.message;
            if (errorMessage.includes("404")) {
               errorMessage = `The model "${apiModelName}" was not found (404).`;
            }
            setMessages(prev => [...prev, { role: 'model', text: `**Error**: ${errorMessage}`, timestamp: Date.now() }]);
          } finally {
            setIsLoading(false);
          }
        };

        // Compare Handler
        const handleCompare = async () => {
          if (!compareInput.trim() || isComparing) return;
          const prompt = compareInput.trim();
          setIsComparing(true);
          
          const targetModels = COMPARE_MODELS.filter(m => activeCompareModels.includes(m.id));

          const initialResults = {};
          targetModels.forEach(m => {
            initialResults[m.id] = { 
              text: '', 
              loading: true, 
              error: null, 
              speed: null,
              groundingMetadata: null
            };
          });
          setCompareResults(initialResults);

          const ai = new GoogleGenAI({ apiKey });

          const runModel = async (model) => {
             const startTime = performance.now(); 

             try {
               const chatConfig = { systemInstruction: systemPrompt };
               if (enableCompareSearch) {
                 chatConfig.tools = [{ googleSearch: {} }];
               }
               if (model.id.includes("2.5")) {
                 const tConfig = compareThinkingConfigs[model.id] || { mode: 'off', budget: 1024 };
                 if (tConfig.mode === 'off') {
                   chatConfig.thinkingConfig = { thinkingBudget: 0 };
                 } else if (tConfig.mode === 'custom') {
                   chatConfig.thinkingConfig = { thinkingBudget: tConfig.budget };
                 }
               }

               const chat = ai.chats.create({
                 model: model.model,
                 config: chatConfig
               });
               
               const resultStream = await chat.sendMessageStream({ message: prompt });
               let fullText = "";
               let groundingMetadata = null;
               
               for await (const chunk of resultStream) {
                 const text = chunk.text;
                 if (text) fullText += text;
                 if (chunk.candidates?.[0]?.groundingMetadata) {
                   groundingMetadata = chunk.candidates[0].groundingMetadata;
                 }
                 
                 setCompareResults(prev => ({
                   ...prev,
                   [model.id]: { 
                      ...prev[model.id], 
                      text: fullText,
                      groundingMetadata: groundingMetadata || prev[model.id]?.groundingMetadata
                   }
                 }));
               }
               
               const endTime = performance.now();
               const durationMs = endTime - startTime;
               const speed = (durationMs).toFixed(0); 

               setCompareResults(prev => ({
                 ...prev,
                 [model.id]: { 
                   ...prev[model.id], 
                   text: fullText, 
                   loading: false, 
                   duration: speed,
                   speed: (fullText.length / (durationMs/1000)).toFixed(1), 
                   groundingMetadata: groundingMetadata 
                 }
               }));

             } catch (err) {
               console.error(err);
               setCompareResults(prev => ({
                 ...prev,
                 [model.id]: { ...prev[model.id], loading: false, error: err.message, duration: 0 }
               }));
             }
          };

          // Simultaneous Execution
          await Promise.all(targetModels.map(model => runModel(model)));
          
          setIsComparing(false);
        };

        // Rapid Fire Handlers
        const handleStartRapidFire = () => {
           if (!rapidInput.trim()) return;
           setIsRapidFiring(true);
           rapidControllerRef.current = new AbortController();
           
           const targetModels = COMPARE_MODELS.filter(m => activeCompareModels.includes(m.id));
           
           // Init Stats with default Key name
           const initStats = {};
           targetModels.forEach(m => {
              initStats[m.id] = { count: 0, lastDuration: 0, error: null, active: true, history: [], isRetrying: false, currentKeyName: activeKeyObj.name };
           });
           setRapidStats(initStats);

           // Start Loop for each model
           targetModels.forEach(model => {
              runRapidLoop(model, rapidInput, rapidControllerRef.current, apiKeys, enableKeyRotation, activeKeyId);
           });
        };

        const handleStopRapidFire = () => {
           setIsRapidFiring(false);
           if (rapidControllerRef.current) {
              rapidControllerRef.current.abort(); 
              rapidControllerRef.current = null;
           }
        };

        const runRapidLoop = async (model, prompt, controller, keysPool, autoSwitch, initialKeyId) => {
           let active = true;
           let keyIndex = keysPool.findIndex(k => k.id === initialKeyId);
           if (keyIndex === -1) keyIndex = 0;

           const updateStat = (updates) => {
              setRapidStats(prev => ({
                 ...prev,
                 [model.id]: { ...prev[model.id], ...updates }
              }));
           };

           while (active && controller && !controller.signal?.aborted) {
              const currentKeyObj = keysPool[keyIndex];
              const currentKey = currentKeyObj.key;

              // Ensure we display current key being used
              updateStat({ currentKeyName: currentKeyObj.name });

              try {
                 // Clean error state before new attempt
                 updateStat({ error: null, isRetrying: false });
                 
                 // Instantiate NEW client per loop to support switching keys dynamically
                 const ai = new GoogleGenAI({ apiKey: currentKey });
                 const chat = ai.chats.create({
                    model: model.model,
                    config: { systemInstruction: "Answer concisely." } 
                 });
                 
                 const start = performance.now();
                 const result = await chat.sendMessage({ message: prompt });
                 const end = performance.now();
                 
                 const duration = end - start;
                 const text = result.text || "";

                 if (controller && !controller.signal?.aborted) {
                    setRapidStats(prev => {
                       const current = prev[model.id];
                       const newHistory = [{ id: current.count + 1, text, duration }, ...(current.history || [])].slice(0, 50); 
                       
                       return {
                          ...prev,
                          [model.id]: { 
                             ...current, 
                             count: current.count + 1, 
                             lastDuration: duration,
                             history: newHistory,
                             error: null,
                             isRetrying: false,
                             currentKeyName: currentKeyObj.name
                          }
                       };
                    });
                 }
              } catch (e) {
                 if (controller?.signal?.aborted) {
                    active = false;
                    break;
                 }

                 // Check for Key Rotation Logic
                 // If error occurs and autoSwitch is ON, we rotate the index
                 let nextAction = "retry";
                 
                 if (autoSwitch && keysPool.length > 1) {
                    keyIndex = (keyIndex + 1) % keysPool.length;
                    // Provide visual feedback of rotation
                    updateStat({ error: `${e.message} (Switching Key...)`, isRetrying: true });
                 } else {
                    updateStat({ error: e.message, isRetrying: true });
                 }
                 
                 // 200ms delay for retry iteration
                 await new Promise(resolve => setTimeout(resolve, 200));
              }
           }
        };


        const currentModelLabel = MODEL_DATA[selectedFamily].find(m => m.id === selectedModel)?.label || selectedModel;

        return (
          <div className="flex h-screen w-full font-sans antialiased text-gray-900 dark:text-gray-100 bg-gray-50 dark:bg-[#09090b] transition-colors duration-500">
            
            <ApiKeyModal 
               isOpen={isKeyModalOpen} 
               onSubmit={handleApiKeySubmit} 
               apiKeys={apiKeys}
               setApiKeys={setApiKeys}
               activeKeyId={activeKeyId}
               setActiveKeyId={setActiveKeyId}
            />

            {/* Content Area Switcher */}
            {viewMode === 'chat' && (
              <ChatInterface 
                messages={messages}
                input={input}
                setInput={setInput}
                isLoading={isLoading}
                handleSend={handleSend}
                selectedFamily={selectedFamily}
                selectedModel={selectedModel}
                currentModelLabel={currentModelLabel}
                messagesEndRef={messagesEndRef}
                chatContainerRef={chatContainerRef}
                onCheck={handleCheck}
                checks={checks}
                onCloseCheckPanel={() => setIsCheckPanelOpen(false)}
                activeKeyName={activeKeyObj.name}
              />
            )}
            
            {viewMode === 'compare' && (
              <CompareInterface 
                compareResults={compareResults}
                isComparing={isComparing}
                compareInput={compareInput}
                setCompareInput={setCompareInput}
                handleCompare={handleCompare}
                activeModels={activeCompareModels}
                activeKeyName={activeKeyObj.name}
              />
            )}

            {viewMode === 'rapid' && (
               <RapidFireInterface 
                  activeModels={activeCompareModels}
                  input={rapidInput}
                  setInput={setRapidInput}
                  handleStart={handleStartRapidFire}
                  handleStop={handleStopRapidFire}
                  isRunning={isRapidFiring}
                  stats={rapidStats}
                  activeKeyName={activeKeyObj.name}
                  enableKeyRotation={enableKeyRotation}
                  setEnableKeyRotation={setEnableKeyRotation}
               />
            )}

            {/* Right Sidebar */}
            <aside className="w-80 shrink-0 bg-gray-50/80 dark:bg-[#0c0c0e]/90 border-l border-gray-200 dark:border-white/5 flex flex-col backdrop-blur-xl z-20 relative shadow-2xl animate-in slide-in-from-right duration-300">
              
              <div className="p-4 border-b border-gray-200 dark:border-white/5 space-y-4">
                <button
                  onClick={handleClearChat}
                  className="w-full flex items-center justify-center gap-2 py-3 px-4 bg-white dark:bg-white/5 hover:bg-red-50 dark:hover:bg-red-900/20 text-gray-700 dark:text-gray-200 hover:text-red-600 dark:hover:text-red-400 rounded-xl border border-gray-200 dark:border-white/10 transition-all font-medium text-sm group shadow-sm"
                >
                  <Trash2 size={16} className="group-hover:scale-110 transition-transform" />
                  {viewMode === 'chat' ? 'New Chat' : 'Clear Results'}
                </button>
                
                 {/* API Key Btn */}
                 <button 
                    onClick={() => setIsKeyModalOpen(true)}
                    className="w-full text-xs font-medium text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 flex items-center justify-center gap-1 bg-transparent px-3 py-2 rounded-lg border border-dashed border-gray-300 dark:border-gray-700 transition-all"
                  >
                    <Key size={12} />
                    Manage Keys
                  </button>
              </div>

              <div className="flex-1 overflow-y-auto p-4 space-y-6">
                <div className="space-y-3">
                  <div className="flex items-center justify-between">
                     <label className="text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 flex items-center gap-2">
                       <Terminal size={12} />
                       System Prompt
                     </label>
                  </div>
                  
                  {isSysPromptExpanded ? (
                     <div className="relative animate-in fade-in zoom-in duration-200">
                        <textarea
                           value={systemPrompt}
                           onChange={(e) => setSystemPrompt(e.target.value)}
                           onBlur={() => setIsSysPromptExpanded(false)}
                           autoFocus
                           className="w-full h-32 bg-white dark:bg-black/20 border border-gray-200 dark:border-white/10 rounded-xl p-3 text-xs font-mono text-gray-600 dark:text-gray-300 focus:outline-none resize-none focus:ring-1 focus:ring-blue-500 shadow-sm"
                           placeholder="Define the AI persona..."
                        />
                        <button 
                           onClick={() => setIsSysPromptExpanded(false)}
                           className="absolute bottom-2 right-2 p-1 bg-gray-100 dark:bg-white/10 rounded-md text-gray-500 hover:text-gray-800 dark:hover:text-white"
                        >
                           <ChevronUp size={12} />
                        </button>
                     </div>
                  ) : (
                     <div 
                        onClick={() => setIsSysPromptExpanded(true)}
                        className="text-xs text-gray-400 dark:text-gray-500 cursor-pointer hover:text-gray-600 dark:hover:text-gray-300 transition-colors p-1 border border-transparent hover:border-gray-200 dark:hover:border-white/5 rounded-lg truncate"
                     >
                        {systemPrompt || "Define the AI persona..."}
                     </div>
                  )}
                </div>
                
                {/* Advanced Tools (Chat Mode) */}
                {viewMode === 'chat' && (
                  <AdvancedTools 
                    enableSearch={enableSearch}
                    setEnableSearch={setEnableSearch}
                    thinkingMode={thinkingMode}
                    setThinkingMode={setThinkingMode}
                    thinkingBudget={thinkingBudget}
                    setThinkingBudget={setThinkingBudget}
                    selectedFamily={selectedFamily}
                  />
                )}

                {/* Compare/Rapid Mode Toggles */}
                {(viewMode === 'compare' || viewMode === 'rapid') && (
                  <CompareToggles 
                    activeModels={activeCompareModels}
                    toggleModel={toggleCompareModel}
                    enableSearch={enableCompareSearch}
                    setEnableSearch={setEnableCompareSearch}
                    thinkingConfigs={compareThinkingConfigs}
                    setThinkingConfigs={setCompareThinkingConfigs}
                  />
                )}
              </div>

              {/* Bottom Controls */}
              <div className="p-4 border-t border-gray-200 dark:border-white/5 bg-gray-100/50 dark:bg-white/5 mt-auto space-y-4">
                
                {/* Model Selector (Only visible in Chat Mode) */}
                {viewMode === 'chat' && (
                  <ModelSelector 
                    selectedModel={selectedModel}
                    setSelectedModel={setSelectedModel}
                    selectedFamily={selectedFamily}
                    setSelectedFamily={setSelectedFamily}
                  />
                )}
                
                {/* Mode Switcher Container */}
                <div className="flex items-center gap-2">
                    {/* Segmented Control */}
                    <div className="flex-1 bg-gray-200 dark:bg-black/30 p-1 rounded-xl grid grid-cols-3 relative">
                       <button
                         onClick={() => setViewMode('chat')}
                         className={`rounded-lg py-2 flex items-center justify-center transition-all ${
                           viewMode === 'chat' 
                             ? 'bg-white dark:bg-[#18181b] shadow-sm text-blue-600 dark:text-blue-400' 
                             : 'text-gray-500 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'
                         }`}
                       >
                         <MessageSquare size={18} />
                       </button>
                       <button
                         onClick={() => setViewMode('compare')}
                         className={`rounded-lg py-2 flex items-center justify-center transition-all ${
                           viewMode === 'compare' 
                             ? 'bg-white dark:bg-[#18181b] shadow-sm text-blue-600 dark:text-blue-400' 
                             : 'text-gray-500 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'
                         }`}
                       >
                         <LayoutGrid size={18} />
                       </button>
                       <button
                         onClick={() => setViewMode('rapid')}
                         className={`rounded-lg py-2 flex items-center justify-center transition-all ${
                           viewMode === 'rapid' 
                             ? 'bg-white dark:bg-[#18181b] shadow-sm text-red-600 dark:text-red-400' 
                             : 'text-gray-500 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'
                         }`}
                       >
                         <Swords size={18} />
                       </button>
                    </div>

                    {/* Theme Toggle - Separate Round Button */}
                    <button
                       onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}
                       className="w-11 h-11 shrink-0 rounded-xl bg-gray-200 dark:bg-black/30 hover:bg-gray-300 dark:hover:bg-black/50 text-gray-600 dark:text-gray-400 transition-all flex items-center justify-center"
                    >
                       {theme === 'dark' ? <Sun size={18} /> : <Moon size={18} />}
                    </button>
                </div>
              </div>
            </aside>

          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
    
